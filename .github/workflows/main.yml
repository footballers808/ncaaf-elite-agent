name: NCAAF Elite Agent

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "run mode"
        required: true
        default: "auto"
        type: choice
        options: [auto, predict, learn, backtest, tune]
      iso_week:
        description: "ISO week to score (yyyy-ww) or 'auto'"
        required: true
        default: "auto"
      pr_apply:
        description: "If 'true', open a PR applying tuned config"
        required: true
        default: "false"
  schedule:
    - cron: "23 11 * * 5"   # Fridays

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: ncaaf-elite-agent-${{ github.ref_name }}
  cancel-in-progress: false

env:
  PYTHONUNBUFFERED: "1"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  CFBD_API_KEY: ${{ secrets.CFBD_API_KEY }}
  PENALTY_CACHE_SCOPE: penalties-Linux-v1
  CFBD_CACHE_SCOPE: cfbd-http-v1

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install -U pip wheel
          pip install -r requirements.txt

      - name: Cache CFBD responses
        id: cfbd-cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/requests_cache
            .cache/requests_cache
          key: ${{ env.CFBD_CACHE_SCOPE }}-${{ github.run_id }}
          restore-keys: |
            ${{ env.CFBD_CACHE_SCOPE }}-

      - name: Restore penalty features cache
        id: penalty-restore
        uses: actions/cache/restore@v4
        with:
          path: artifacts/features
          key: ${{ env.PENALTY_CACHE_SCOPE }}-${{ github.sha }}
          restore-keys: |
            ${{ env.PENALTY_CACHE_SCOPE }}-

      - name: Sanity import check
        run: |
          python - <<'PY'
import importlib
for m in ["src.tools.validate_config","src.data_penalties","src.labeler","src.learn","src.predict","src.reporter","src.features","src.news"]:
    importlib.import_module(m)
print("imports ok")
PY

      - name: Apply tuned config if present + validate
        run: |
          set -e
          if [ -f tuning-results/best_config.yaml ]; then
            cp tuning-results/best_config.yaml config.yaml
          fi
          python -m src.tools.validate_config

      # --------- Backfill penalties (staged 5-3-1) ----------
      - name: Backfill penalties (staged 5-3-1)
        if: ${{ contains(fromJSON('["auto","learn","predict"]'), github.event.inputs.mode) || github.event_name == 'schedule' }}
        run: |
          set -e
          python -m src.data_penalties --years 5 --windows 3,5,10 --strict
          python -m src.data_penalties --years 3 --windows 3,5,10 --strict
          python -m src.data_penalties --years 1 --windows 3,5,10 --strict
          ls -l artifacts/features || true

      - name: Save penalty features cache
        if: ${{ always() }}
        uses: actions/cache/save@v4
        with:
          path: artifacts/features
          key: ${{ env.PENALTY_CACHE_SCOPE }}-${{ github.sha }}

      # --------- Predict ----------
      - name: Predict (scores)
        if: ${{ contains(fromJSON('["auto","predict"]'), github.event.inputs.mode) || github.event_name == 'schedule' }}
        run: |
          set -e
          ISO="${{ github.event.inputs.iso_week }}"
          if [ -z "$ISO" ] || [ "$ISO" = "auto" ]; then
            ISO=$(python - <<'PY'
import datetime
d=datetime.date.today()
iso=d.isocalendar()
print(f"{iso.year}-{iso.week:02d}")
PY
)
          fi
          echo "Scoring ISO week: $ISO"
          python -m src.predict --iso-week "$ISO" --features artifacts/features/penalties.parquet --out artifacts/preds.parquet

      # --------- Label ----------
      - name: Label
        if: ${{ contains(fromJSON('["auto","learn"]'), github.event.inputs.mode) || github.event_name == 'schedule' }}
        run: |
          set -e
          Y=$(date -u +%Y)
          python -m src.labeler --year "$Y" --season-type regular

      # --------- News (Beat writer enrichment) ----------
      - name: News enrichment (optional, safe if no file)
        if: ${{ contains(fromJSON('["auto","learn"]'), github.event.inputs.mode) || github.event_name == 'schedule' }}
        run: |
          set -e
          # If no input file, create an empty CSV so step always succeeds
          test -f data/news_feed.csv || { mkdir -p data; echo "team,text" > data/news_feed.csv; }
          python -m src.news --in data/news_feed.csv --out artifacts/features/news.parquet

      # --------- Learn ----------
      - name: Learn (strict, real data)
        if: ${{ contains(fromJSON('["auto","learn"]'), github.event.inputs.mode) || github.event_name == 'schedule' }}
        run: |
          set -e
          test -f artifacts/features/penalties.parquet || { echo "missing penalties.parquet"; exit 1; }
          test -f artifacts/labels.parquet || { echo "missing labels.parquet"; exit 1; }
          python -m src.learn --features artifacts/features/penalties.parquet --labels artifacts/labels.parquet --out artifacts/model.joblib

      # --------- Report ----------
      - name: Report
        if: ${{ contains(fromJSON('["auto","predict","learn"]'), github.event.inputs.mode) || github.event_name == 'schedule' }}
        run: |
          set -e
          if [ -f artifacts/preds.parquet ]; then
            python -m src.reporter --preds artifacts/preds.parquet --out artifacts/report.md
          else
            printf "# NCAAF Elite Agent\n\n- run id: %s\n" "$GITHUB_RUN_ID" > artifacts/report.md
          fi

      - name: Upload artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: run-artifacts
          path: |
            artifacts/**
            tuning-results/**
          if-no-files-found: ignore
